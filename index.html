<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì• í”Œí˜ì´ ê°€ë§¹ì  ì°¾ê¸°</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="styles.css" />
  <meta name="color-scheme" content="light" />
  <style>
    html,body,#map{height:100%;margin:0}
    .topbar{ position:absolute; z-index:500; left:50%; transform:translateX(-50%);
      top:.8rem; display:flex; gap:.5rem; align-items:center; background:#fff;
      border:1px solid #e5e7eb; border-radius:999px; padding:.45rem .6rem; box-shadow:0 2px 10px rgba(0,0,0,.06);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .brand{ font-weight:700; margin:0 .4rem; }
    .search-box{ display:flex; gap:.4rem; align-items:center; }
    .search-box input{ width:16rem; max-width:40vw; padding:.45rem .7rem; border:1px solid #e5e7eb; border-radius:999px; }
    .search-box button, .actions button{ padding:.45rem .6rem; border:1px solid #e5e7eb; border-radius:999px; background:#f8f8f8; }
    .actions{ display:flex; gap:.3rem; margin-left:.3rem; }
    @media (max-width:600px){ .search-box input{ width:12rem; } }

    /* ë§ˆì»¤/íŒì—… */
    .ap-pin .pin{ font-size:22px; line-height:22px; transform:translate(-2px,-2px); }
    .popup{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-size:14px; }
    .popup .title{ font-weight:700; margin-bottom:4px; }
    .popup .row{ margin:2px 0; }
    .popup .muted{ color:#6b7280; }

    /* í† ìŠ¤íŠ¸ */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:1rem;background:#111;color:#fff;padding:.5rem .75rem;border-radius:.6rem;opacity:0;transition:opacity .2s;z-index:600}
    .toast.show{opacity:.92}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar" role="banner">
    <div class="brand">ì• í”Œí˜ì´ ê°€ë§¹ì  ì°¾ê¸°</div>
    <div class="search-box" role="search">
      <input id="search" placeholder="ìƒí˜¸/ë¸Œëœë“œ ê²€ìƒ‰ (ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤, GS25)" aria-label="ê²€ìƒ‰ì–´" />
      <button id="search-submit" aria-label="ê²€ìƒ‰">ğŸ”</button>
    </div>
    <div class="actions">
      <button id="btn-geoloc" title="ë‚´ ìœ„ì¹˜" aria-label="ë‚´ ìœ„ì¹˜">ğŸ“</button>
      <button id="btn-scan" title="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”" aria-label="í˜„ì¬ í™”ë©´ ì¬ìŠ¤ìº”">ğŸ§­</button>
      <button id="btn-add" title="ê°€ë§¹ì  ì¶”ê°€(GitHub)" aria-label="ê°€ë§¹ì  ì¶”ê°€">â•</button>
      <button id="btn-center" title="ì›ì£¼ í„°ë¯¸ë„ë¡œ" aria-label="ì›ì£¼ í„°ë¯¸ë„ë¡œ">ğŸ¯</button>
    </div>
  </div>

  <!-- ì§€ë„ -->
  <div id="map" role="region" aria-label="Myapplepaymaps"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // =========================
  // Config
  // =========================
  const CFG = {
    OWNER:'diligencefrozen', REPO:'myapplepaymaps', ISSUE_LABEL:'add-merchant',
    CENTER:[37.345040,127.930825], // ì›ì£¼ì¢…í•©ë²„ìŠ¤í„°ë¯¸ë„ (ì§€ì˜¤ë¡œì¼€ì´ì…˜ ì‹¤íŒ¨ì‹œ)
    INIT_ZOOM: 15,
    LIMIT: 2000,       // Overpass out limit
    OVERPASS: [
      'https://overpass-api.de/api/interpreter',
      'https://overpass.kumi.systems/api/interpreter',
      'https://overpass.osm.ch/api/interpreter'
    ]
  };

  // âœ… "ì• í”Œí˜ì´ ì§€ì› ê°€ë§¹ì "ìœ¼ë¡œ ë…¸ì¶œí•  ë¸Œëœë“œë§Œ ì •ì˜
  const APPLE_BRANDS = [
    { id:'gs25', label:'í¸ì˜ì ', icon:'ğŸ›’',
      brandRE: /(gs ?25|ì§€ì—ìŠ¤ ?25)/i, nameRE: /(gs ?25|ì§€ì—ìŠ¤ ?25)/i, filter:{ shop:'convenience' } },
    { id:'starbucks', label:'ì¹´í˜', icon:'â˜•',
      brandRE: /(starbucks|ìŠ¤íƒ€ë²…ìŠ¤)/i, nameRE: /(starbucks|ìŠ¤íƒ€ë²…ìŠ¤)/i, filter:{ amenity:'cafe' } }
    // ì¶”ê°€ ì˜ˆ) CU
    // { id:'cu', label:'í¸ì˜ì ', icon:'ğŸ›’', brandRE:/\bcu\b|ì”¨ìœ /i, nameRE:/\bcu\b|ì”¨ìœ /i, filter:{ shop:'convenience' } }
  ];

  // =========================
  // Helpers
  // =========================
  const $ = (s,r=document)=>r.querySelector(s);
  const esc = s=>String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
  function toast(msg){ const el=document.body.appendChild(Object.assign(document.createElement('div'),{className:'toast',textContent:msg})); setTimeout(()=>el.classList.add('show')); setTimeout(()=>{el.classList.remove('show'); setTimeout(()=>el.remove(),300)},2000); }
  function iconFor(icon){ return L.divIcon({ className:'ap-pin', html:`<div class="pin">${icon}</div>` }); }

  // ì£¼ì†Œ ì¡°í•© (OSM íƒœê·¸ â†’ ë¬¸ìì—´)
  function addrFromTags(tags={}){
    if(tags['addr:full']) return tags['addr:full'];
    const parts = [
      tags['addr:postcode'],
      tags['addr:province']||tags['addr:state']||tags['addr:region'],
      tags['addr:city']||tags['addr:town']||tags['addr:county']||tags['addr:district'],
      tags['addr:suburb']||tags['addr:neighbourhood']||tags['addr:quarter'],
      tags['addr:street']||tags['addr:road'],
      tags['addr:door']||tags['addr:block'],
      tags['addr:housenumber']||tags['addr:house_number']
    ].filter(Boolean);
    return parts.join(' ').replace(/\s+/g,' ').trim();
  }

  // Overpass í˜¸ì¶œ (ì—¬ëŸ¬ ì—”ë“œí¬ì¸íŠ¸ í´ë°±)
  async function fetchOverpass(query){
    let lastErr;
    for(const ep of CFG.OVERPASS){
      try{
        const res = await fetch(ep, { method:'POST', body:new URLSearchParams({ data: query }) });
        if(!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error('Overpass failed');
  }

  // ë¸Œëœë“œ â†’ Overpass ì„œë¸Œì¿¼ë¦¬(nwr + out center ì§€ì›)
  function brandToOverpassSub(br, bbox){
    const [s,w,n,e] = bbox;
    const filt = br.filter || {};
    const tagPairs = Object.entries(filt).map(([k,v])=>`["${k}"="${v}"]`).join('');
    const brandRE = br.brandRE ? br.brandRE.toString().replace(/^\/|\/[a-z]*$/g,'') : '';
    const nameRE  = br.nameRE  ? br.nameRE.toString().replace(/^\/|\/[a-z]*$/g,'')  : '';
    const parts = [];
    if(brandRE){
      parts.push(`nwr${tagPairs}["brand"~"${brandRE}",i](${s},${w},${n},${e});`);
    }
    if(nameRE){
      parts.push(`nwr${tagPairs}["name"~"${nameRE}",i](${s},${w},${n},${e});`);
    }
    return parts.join('\n');
  }

  // í˜„ì¬ í™”ë©´(BBox) ì•ˆì—ì„œ ì• í”Œí˜ì´ ë¸Œëœë“œë“¤ë§Œ ì¡°íšŒ
  function buildQueryForBrands(bounds){
    const s = bounds.getSouth(), w = bounds.getWest(), n = bounds.getNorth(), e = bounds.getEast();
    const subs = APPLE_BRANDS.map(br=>brandToOverpassSub(br,[s,w,n,e])).join('\n');
    return `
[out:json][timeout:25];
(
${subs}
);
out ${CFG.LIMIT} center;
`;
  }

  // =========================
  // Map
  // =========================
  const map = L.map('map', { zoomControl:true, scrollWheelZoom:true }).setView(CFG.CENTER, CFG.INIT_ZOOM);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
    maxZoom:19
  }).addTo(map);

  const layer = L.layerGroup().addTo(map);
  const seen = new Set(); // ì¤‘ë³µ ë°©ì§€(osm id)

  let debounceTimer=null, lastFetchAt=0, inFlight=false;
  function scheduleLoad(delay=350){
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=> loadInView(), delay);
  }

  async function loadInView(){
    if(inFlight) return;
    inFlight = true;
    try{
      const now = Date.now();
      if(now - lastFetchAt < 500) { inFlight=false; return; }
      lastFetchAt = now;

      const bounds = map.getBounds();
      toast('ì• í”Œí˜ì´ ê°€ë§¹ì  ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
      const data = await fetchOverpass(buildQueryForBrands(bounds));

      let added = 0;
      (data.elements||[]).forEach(el=>{
        const { id, tags={} } = el;
        const lat = el.lat ?? el.center?.lat;
        const lon = el.lon ?? el.center?.lon;
        if(!isFinite(lat) || !isFinite(lon)) return;
        if(seen.has(id)) return; seen.add(id);

        // ì–´ë–¤ ë¸Œëœë“œ ê·œì¹™ì— ë§¤ì¹­ëëŠ”ì§€ ì°¾ì•„ ë¼ë²¨ ê²°ì •
        let brSpec = APPLE_BRANDS.find(br=>{
          const filtOK = Object.entries(br.filter||{}).every(([k,v]) => tags[k] === v);
          const mBrand = br.brandRE ? br.brandRE.test(tags.brand||'') : false;
          const mName  = br.nameRE  ? br.nameRE.test(tags.name||'')  : false;
          return filtOK && (mBrand || mName);
        });
        if(!brSpec) return;

        const title = tags.name || tags.brand || brSpec.id.toUpperCase();
        const brandText = tags.brand ? `ë¸Œëœë“œ: ${esc(tags.brand)}` : '';
        const addr = addrFromTags(tags);
        const addrRow = addr ? `<div class="row">ì£¼ì†Œ: ${esc(addr)}</div>` : `<div class="row">ì¢Œí‘œ: ${lat.toFixed(6)}, ${lon.toFixed(6)}</div>`;

        L.marker([lat, lon], { icon: iconFor(brSpec.icon) })
         .bindPopup(`
           <div class="popup">
             <div class="title">${esc(title)}</div>
             ${brandText ? `<div class="row">${brandText}</div>`:''}
             ${addrRow}
             <div class="row">ì• í”Œí˜ì´: <b>ì§€ì›(ë¸Œëœë“œ ì§€ì •)</b></div>
             <div class="row">ë¶„ë¥˜: ${esc(brSpec.label)}</div>
           </div>
         `)
         .bindTooltip(`${brSpec.label}`, {direction:'top', offset:[0,-8]})
         .addTo(layer);
        added++;
      });

      toast(added ? `í‘œì‹œë¨: ${added}ê³³` : 'í˜„ì¬ í™”ë©´ì— í‘œì‹œí•  í•­ëª©ì´ ì—†ì–´ìš”');
    }catch(e){
      console.error(e);
      toast('ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆì–´ìš” (Overpass ìƒíƒœ/ë„¤íŠ¸ì›Œí¬)');
    }finally{
      inFlight=false;
    }
  }

  // =========================
  // Search (í˜„ì¬ í‘œì¶œ ë§ˆì»¤ í•„í„°)
  // =========================
  function filterVisible(q){
    q = (q||'').trim().toLowerCase();
    layer.eachLayer(m=>{
      const html = m.getPopup()?.getContent() || '';
      const ok = !q || html.toLowerCase().includes(q);
      if(ok){ m.addTo(layer); } else { layer.removeLayer(m); }
    });
  }
  $('#search-submit').addEventListener('click', ()=> filterVisible($('#search').value));
  $('#search').addEventListener('keydown', e=>{ if(e.key==='Enter') filterVisible(e.target.value); });

  // =========================
  // Buttons & UX
  // =========================
  $('#btn-geoloc').addEventListener('click', geolocateAndLoad);
  $('#btn-scan').addEventListener('click', ()=> { scheduleLoad(0); });
  $('#btn-center').addEventListener('click', ()=>{
    map.setView(CFG.CENTER, CFG.INIT_ZOOM);
    scheduleLoad(0);
  });
  $('#btn-add').addEventListener('click', ()=>{
    const once = e=>{
      const { lat, lng } = e.latlng;
      openIssueWith(lat, lng);
      map.off('click', once);
    };
    toast('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”. ê¹ƒí—ˆë¸Œ ì´ìŠˆê°€ ì—´ë¦½ë‹ˆë‹¤');
    map.once('click', once);
  });

  function openIssueWith(lat, lon){
    const base = `https://github.com/${encodeURIComponent(CFG.OWNER)}/${encodeURIComponent(CFG.REPO)}/issues/new`;
    const params = new URLSearchParams();
    params.set('title', '[Add] Apple Pay Merchant');
    params.set('labels', CFG.ISSUE_LABEL);
    const body = [
      '**ìƒí˜¸ëª…**\n',
      '**ì¹´í…Œê³ ë¦¬**\nconv / cafe / resto / mart / bakery / pharmacy / transport / other\n',
      '**ìœ„ë„/ê²½ë„**\n', `lat: ${lat}\nlon: ${lon}\n`,
      '**ì• í”Œí˜ì´** (í•´ë‹¹ì— ì²´í¬)\n', '- [ ] Contactless\n- [ ] In-App\n- [ ] Express\n',
      '**ë¹„ê³ /ì¶œì²˜(ì„ íƒ)**\n'
    ].join('\n');
    params.set('body', body);
    window.open(`${base}?${params.toString()}`, '_blank');
  }

  // í™”ë©´ ì´ë™í•  ë•Œë§ˆë‹¤ ìë™ ë¡œë”©(ê³¼í˜¸ì¶œ ë°©ì§€ ë””ë°”ìš´ìŠ¤)
  map.on('moveend', ()=> scheduleLoad(300));

  // =========================
  // Auto start: ë‚´ ìœ„ì¹˜ â†’ í˜„ì¬ í™”ë©´ ë¡œë”©
  // =========================
  function geolocateAndLoad(){
    if(!navigator.geolocation){
      map.setView(CFG.CENTER, CFG.INIT_ZOOM);
      scheduleLoad(0);
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      const { latitude:lat, longitude:lon } = pos.coords;
      map.setView([lat,lon], 16);
      scheduleLoad(0);
    }, ()=>{
      map.setView(CFG.CENTER, CFG.INIT_ZOOM);
      scheduleLoad(0);
    }, { enableHighAccuracy:true, timeout:8000, maximumAge:30000 });
  }
  geolocateAndLoad();
  </script>
</body>
</html>
